<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ SERVICE_NAME }}</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .facility-card { border: 1px solid #ddd; margin: 20px 0; padding: 20px; border-radius: 8px; }
        .facility-header { display: flex; justify-content: space-between; align-items: center; }
        .status-container { margin-top: 15px; }
        .status-bar { display: flex; height: 30px; margin-top: 5px; }
        .status-slot { flex: 1; border-right: 1px solid #fff; text-align: center; color: white; font-size: 10px; line-height: 30px; }
        .status-slot:last-child { border-right: none; }
        
        .available { background-color: #4CAF50; } 
        .booked { background-color: #ccc; }       
        
        .legend { font-size: 12px; color: #666; margin-bottom: 5px; }
        
        button { padding: 10px 15px; cursor: pointer; }
        
        button:disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            border: 1px solid #999;
        }

        /* 날짜 입력창 스타일 개선 */
        .search-box { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        input[type="date"] { padding: 8px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>{{ SERVICE_NAME }}</h1>

    <div class="search-box">
        <h3>어떤 공간을 찾고 계신가요?</h3>
        <p>원하는 날짜를 선택하면 예약 현황이 갱신됩니다.</p>
        
        <form id="searchForm" method="get" action="/">
            <label>날짜 선택: 
                <input type="date" name="date" id="dateInput" 
                       value="{{ selected_date if selected_date else '' }}" 
                       required
                       onchange="document.getElementById('searchForm').submit();">
            </label>
            </form>
    </div>

    <hr>

    <h2>예약 가능 시설 목록</h2>
    
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <p style="color:red; font-weight:bold;">{{ messages[0] }}</p>
      {% endif %}
    {% endwith %}

    {% if not selected_date %}
        <p style="color: blue;">위에서 날짜를 선택해주세요.</p>
    {% else %}
        <p><strong>선택된 날짜:</strong> {{ selected_date }}</p>
    {% endif %}

    <div>
        {% for f in facilities %}
        <div class="facility-card">
            <div class="facility-header">
                <div>
                    <h3>{{ f.name }} <small style="color: #666; font-size: 0.8em;">({{ f.type }})</small></h3>
                    <p>{{ f.description if f.description else "설명 없음" }}</p>
                </div>
                
                <form method="get" action="{{ url_for('reserve', facility_id=f.id) }}">
                    <input type="hidden" name="date" value="{{ selected_date }}">
                    
                    {% set is_sold_out = False %}
                    {% if selected_date and availability_data %}
                        {% if 'available' not in availability_data[f.id].values() %}
                            {% set is_sold_out = True %}
                        {% endif %}
                    {% endif %}

                    {% if not selected_date %}
                        <button type="button" disabled>날짜를 선택해주세요</button>
                    {% elif not is_reservable %}
                         <button type="submit" disabled>예약 불가 (과거/오늘)</button>
                    {% elif is_sold_out %}
                        <button type="submit" disabled>예약 마감</button>
                    {% else %}
                        <button type="submit">상세보기 및 예약</button>
                    {% endif %}
                </form>
            </div>

            {% if selected_date and availability_data %}
            <div class="status-container">
                <div class="legend">예약 현황 (09:00 ~ 18:00)</div>
                <div class="status-bar">
                    {% for h in range(9, 18) %}
                        {% set status = availability_data[f.id][h] %}
                        <div class="status-slot {{ status }}" title="{{ h }}:00 ~ {{ h+1 }}:00">
                            {{ h }}
                        </div>
                    {% endfor %}
                </div>
                <div style="font-size: 11px; margin-top: 4px; color: #888;">
                    <span style="display:inline-block; width:10px; height:10px; background:#4CAF50;"></span> 예약가능
                    <span style="display:inline-block; width:10px; height:10px; background:#ccc; margin-left:10px;"></span> 예약마감
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <script>
    // [수정 5] 페이지 로드 시 날짜가 없으면 자동으로 오늘 날짜 세팅 (선택사항)
    // 날짜를 세팅하면서 바로 조회를 하려면 submit()을 호출하면 되지만, 
    // 무한 리로딩을 방지하기 위해 value만 채우거나, 사용자가 직접 선택하게 둡니다.
    window.onload = function() {
        const dateInput = document.getElementById("dateInput");
        // 만약 서버에서 넘어온 날짜가 없다면(첫 접속), 오늘 날짜를 기본값으로 보여주기만 함 (자동 조회 X)
        if (!dateInput.value) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            // dateInput.value = `${yyyy}-${mm}-${dd}`; // 필요 시 주석 해제
        }
    }
    
    // 기존의 복잡한 checkReservationDate 함수는 이제 필요가 거의 없으므로 삭제하거나
    // 만일의 경우를 대비해 최소한의 방어만 남겨둡니다.
    </script>
</body>
</html>